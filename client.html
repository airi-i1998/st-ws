<!DOCTYPE html>
<html lang="ja">
  <meta charset="UTF-8" />
  <title>WebSocket Client</title>
  <style>
    body {
      font-family: system-ui;
      margin: 2rem;
    }
    #log {
      border: 1px solid #ccc;
      padding: 8px;
      height: 180px;
      overflow: auto;
    }
    button {
      padding: 8px 12px;
      font-size: 14px;
    }
  </style>

  <h1>WebSocket Client</h1>
  <p>
    ã“ã®ãƒšãƒ¼ã‚¸ã‚’<strong>2ã‚¿ãƒ–</strong>ã§é–‹ã„ã¦ã€ç‰‡æ–¹ã§ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€ã‚‚ã†ç‰‡æ–¹ã«ã‚‚è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
  </p>

  <div style="display: flex; gap: 12px; align-items: center">
    <button id="sendBtn">ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯âœ…</button>
    <span id="status">ğŸ”´ disconnected</span>
  </div>

  <h3>å—ä¿¡ãƒ­ã‚°</h3>
  <div id="log"></div>
  <script>
    const $ = (id) => document.getElementById(id);
    const log = (msg) => {
      // <div id="log"></div>ã¿ãŸã„ãªHTMLè¦ç´ ã‚’å–å¾—ã—ã¦ã„ã‚‹
      const el = $("log");
      // innerHTMLï¼šãã®è¦ç´ ã®ä¸­èº«(HTML)ã‚’è¡¨ã™ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£
      // +=ã§ã€ä»Šã‚ã‚‹ä¸­èº«ã«æ–°ã—ã„è¡Œã‚’è¿½åŠ ã—ã¦ã„ã‚‹
      el.innerHTML += `<div>${new Date().toLocaleTimeString()} - ${msg}</div>`;
      // å…¨éƒ¨è¡¨ç¤ºã—ãªã„ã§ã€ä¸­ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã•ã›ã‚‹
      el.scrollTop = el.scrollHeight;
    };
    // textContentï¼šHTMLã‚¿ã‚°å†…ã®ãƒ†ã‚­ã‚¹ãƒˆéƒ¨åˆ†ã‚’ä¸Šæ›¸ãã™ã‚‹ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£
    const ws = new WebSocket("ws://localhost:3001");
    ws.addEventListener("open", () => {
      $("status").textContent = "ğŸŸ¢ connected";
      log("æ¥ç¶šå®Œäº†");
    });
    ws.addEventListener("close", () => {
      $("status").textContent = "ğŸ”´ disconnected";
      log("åˆ‡æ–­ã•ã‚Œã¾ã—ãŸ");
    });
    ws.addEventListener("error", () => {
      log("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
    });

    // ã‚µãƒ¼ãƒãƒ¼ãŒèª°ã‹ãŒã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚ˆã¨ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆã—ãŸé€šçŸ¥ã‚’å—ã‘ã¨ã£ã¦è¡¨ç¤ºã—ã¦ã„ã‚‹
    ws.addEventListener("message", async (event) => {
      let raw;
      try {
        // Blobï¼šBinary Large Objectã®ç•¥ã§ã€ãƒ–ãƒ©ã‚¦ã‚¶ã§ãƒã‚¤ãƒŠãƒªãƒ‡ãƒ¼ã‚¿ï¼ˆç”»åƒãƒ»å‹•ç”»ãƒ»ãƒ•ã‚¡ã‚¤ãƒ«ãªã©ï¼‰ã‚’æ‰±ã†ãŸã‚ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
        raw = event.data instanceof Blob
          ? await event.data.text()
          : typeof event.data === 'string'
            ? event.data
            : JSON.stringify(event.data);
        // javascriptã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›
        const msg = JSON.parse(raw);
        if (msg.type === "CLICK") {
          // payloadï¼šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æœ¬ä½“éƒ¨åˆ†
          log(
            `ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸï¼šby ${msg.payload.id} @ ${new Date(
              msg.payload.at
            ).toLocaleTimeString()}`
          );
        } else {
          log(`unknown ${raw}`);
        }
      } catch {
        log(`raw: ${raw}`);
      }
    });

    $("sendBtn").addEventListener("click", () => {
      if (ws.readyState !== WebSocket.OPEN) log("æœªæ¥ç¶šã§ã™");
      // ãƒ‡ãƒ¼ã‚¿ã‚’é€ã‚‹å®šç¾©
      const payload = {
        type: "CLICK",
        payload: {
          id: crypto.randomUUID().slice(0, 8),
          at: new Date(Date.now()),
        },
      };
      // JSONå½¢å¼ã«ã—ã¦é€ä¿¡
      ws.send(JSON.stringify(payload));
      log("ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã—ãŸï¼ˆé€ä¿¡å®Œäº†ï¼‰");
    });
  </script>
</html>
